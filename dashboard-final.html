<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guest Comment - Laporan Gerai</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .card .number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .card .label {
            color: #666;
            font-size: 0.9rem;
        }

        .gerai-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .gerai-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .gerai-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
            border-radius: 10px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .score-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .rating-breakdown {
            margin-top: 15px;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .rating-item:last-child {
            border-bottom: none;
        }

        .rating-bar {
            flex-grow: 1;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }

        .rating-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.8s ease;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .insights {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .insights h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .positive { border-left-color: #28a745; background: #f0f9ff; }
        .negative { border-left-color: #dc3545; background: #fff5f5; }
        .neutral { border-left-color: #ffc107; background: #fffdf0; }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .gerai-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .stats-item {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .highlight {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* Toolbar & Comments - modern clean UI */
        .comments-section {
            margin-top: 30px;
        }

        .toolbar {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: sticky;
            top: 10px;
            z-index: 10;
        }

        .toolbar select, .toolbar input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            outline: none;
            background: #fafafa;
            transition: border-color .2s ease, background .2s ease;
        }

        .toolbar select:focus, .toolbar input[type="text"]:focus {
            border-color: #667eea;
            background: #fff;
        }

        .segmented {
            display: inline-flex;
            background: #f3f4f6;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .segment {
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        .segment.active {
            background: #667eea;
            color: white;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(102,126,234,.35);
        }

        .btn:active { transform: translateY(1px); }

        .comments-stats {
            margin: 16px 0 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pill {
            padding: 6px 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            font-size: 0.85rem;
        }

        .comments-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .comment-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .comment-meta {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: .2px;
        }

        .badge.positive { background: #e6f7ed; color: #2e7d32; border: 1px solid #b7e4c7; }
        .badge.neutral { background: #fff8e6; color: #b7791f; border: 1px solid #fde68a; }
        .badge.negative { background: #ffe8e8; color: #b91c1c; border: 1px solid #fecaca; }

        .comment-text { color: #374151; line-height: 1.5; }
        .aspect-chips { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip { font-size: 0.75rem; padding: 4px 8px; border-radius: 999px; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }

        @media(max-width: 900px) {
            .toolbar { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Dashboard Guest Comment</h1>
            <p>Laporan Analisis Kepuasan Pelanggan Semua Gerai - Data Real Time</p>
        </div>

        <div class="loading" id="loading">
            <div>‚è≥ Memuat dan menganalisis data...</div>
            <div style="font-size: 0.9rem; margin-top: 10px;">Memproses 499+ review dari 6 gerai</div>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="summary-cards" id="summary-cards">
                <!-- Summary cards akan diisi oleh JavaScript -->
            </div>

            <div class="gerai-section" id="gerai-section">
                <!-- Gerai cards akan diisi oleh JavaScript -->
            </div>

            <div class="charts-section">
                <div class="chart-card">
                    <h3>üìä Perbandingan Sentiment Score Antar Gerai</h3>
                    <canvas id="sentimentChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>‚≠ê Perbandingan Rate Score Antar Gerai</h3>
                    <canvas id="rateChart"></canvas>
                </div>
            </div>

            <div class="insights" id="insights">
                <h3>üí° Insight & Rekomendasi</h3>
                <!-- Insights akan diisi oleh JavaScript -->
            </div>

            <!-- Komentar Pelanggan -->
            <div class="comments-section">
                <div class="toolbar">
                    <input type="text" id="filterSearch" placeholder="Cari komentar, nama, atau alamat..." aria-label="Cari komentar" />
                    <div class="segmented" role="tablist" aria-label="Filter Sentiment">
                        <div class="segment active" data-sentiment="all">Semua</div>
                        <div class="segment" data-sentiment="positive">Positif</div>
                        <div class="segment" data-sentiment="neutral">Netral</div>
                        <div class="segment" data-sentiment="negative">Negatif</div>
                    </div>
                    <select id="filterGerai" aria-label="Pilih Gerai">
                        <option value="all">Semua Gerai</option>
                    </select>
                    <button class="btn" id="btnExport">‚¨áÔ∏è Download CSV</button>
                </div>
                <div class="comments-stats" id="comments-stats"></div>
                <div class="comments-list" id="comments-list"></div>
            </div>
        </div>
    </div>

    <!-- Load data dari file eksternal -->
    <script src="csv_data.js"></script>
    
    <script>
        // Sistem scoring sesuai permintaan: Tinggi(5), Biasa(3), Tidak enak(-1), NULL(0)
        function getScore(rating) {
            if (!rating || rating === 'NULL' || rating === '-' || rating === '(tidak diisi)' || rating === '(coretan)') return 0;
            
            const ratingLower = rating.toLowerCase().trim();
            
            // Rating negatif
            if (ratingLower.includes('tidak nyaman') || ratingLower.includes('tidak bersih')) return -1;
            
            // Rating tinggi (5)
            if (ratingLower.includes('enak sekali') || ratingLower.includes('baik sekali') || 
                ratingLower.includes('nyaman sekali') || ratingLower.includes('bersih sekali')) return 5;
            
            // Rating biasa (3) 
            if (ratingLower.includes('enak') || ratingLower.includes('baik') || 
                ratingLower.includes('nyaman') || ratingLower.includes('bersih') || 
                ratingLower.includes('biasa')) return 3;
            
            return 0; // default
        }

        function processGerai(geraiName, data) {
            const reviews = data.slice(1); // Skip header
            let totalSentiment = 0;
            let totalRate = 0;
            let validReviews = 0;
            let positiveReviews = 0;
            let negativeReviews = 0;
            
            const ratingCounts = {
                'Makanan': {5: 0, 3: 0, '-1': 0, 0: 0},
                'Pelayanan': {5: 0, 3: 0, '-1': 0, 0: 0},
                'Kenyamanan': {5: 0, 3: 0, '-1': 0, 0: 0},
                'Kebersihan': {5: 0, 3: 0, '-1': 0, 0: 0}
            };

            reviews.forEach(review => {
                if (review.length >= 7) {
                    const makananScore = getScore(review[3]);
                    const pelayananScore = getScore(review[4]);
                    const kenyamananScore = getScore(review[5]);
                    const kebersihanScore = getScore(review[6]);
                    
                    // Update rating counts
                    ratingCounts['Makanan'][makananScore]++;
                    ratingCounts['Pelayanan'][pelayananScore]++;
                    ratingCounts['Kenyamanan'][kenyamananScore]++;
                    ratingCounts['Kebersihan'][kebersihanScore]++;
                    
                    // Sentiment score (average of all ratings)
                    const avgScore = (makananScore + pelayananScore + kenyamananScore + kebersihanScore) / 4;
                    totalSentiment += avgScore;
                    totalRate += avgScore;
                    
                    if (avgScore > 3.5) positiveReviews++;
                    else if (avgScore < 2) negativeReviews++;
                    
                    validReviews++;
                }
            });

            return {
                name: geraiName,
                totalReviews: reviews.length,
                validReviews: validReviews,
                sentimentScore: validReviews > 0 ? (totalSentiment / validReviews) : 0,
                rateScore: validReviews > 0 ? (totalRate / validReviews) : 0,
                ratingBreakdown: ratingCounts,
                positiveReviews: positiveReviews,
                negativeReviews: negativeReviews,
                satisfactionRate: validReviews > 0 ? ((positiveReviews / validReviews) * 100) : 0
            };
        }

        function generateSummaryCards(processedData) {
            const totalReviews = processedData.reduce((sum, gerai) => sum + gerai.totalReviews, 0);
            const avgSentiment = processedData.reduce((sum, gerai) => sum + parseFloat(gerai.sentimentScore), 0) / processedData.length;
            const avgRate = processedData.reduce((sum, gerai) => sum + parseFloat(gerai.rateScore), 0) / processedData.length;
            const bestGerai = processedData.reduce((best, current) => 
                parseFloat(current.sentimentScore) > parseFloat(best.sentimentScore) ? current : best
            );
            const totalPositive = processedData.reduce((sum, gerai) => sum + gerai.positiveReviews, 0);
            const avgSatisfaction = processedData.reduce((sum, gerai) => sum + gerai.satisfactionRate, 0) / processedData.length;

            return `
                <div class="card">
                    <h3>üìä Total Review</h3>
                    <div class="number">${totalReviews}</div>
                    <div class="label">Semua Gerai</div>
                </div>
                <div class="card">
                    <h3>üòä Sentiment Score</h3>
                    <div class="number">${avgSentiment.toFixed(2)}</div>
                    <div class="label">dari 5.0</div>
                </div>
                <div class="card">
                    <h3>‚≠ê Average Rate</h3>
                    <div class="number">${avgRate.toFixed(2)}</div>
                    <div class="label">dari 5.0</div>
                </div>
                <div class="card">
                    <h3>üèÜ Gerai Terbaik</h3>
                    <div class="number" style="font-size: 1.5rem;">${bestGerai.name}</div>
                    <div class="label">Score: ${bestGerai.sentimentScore.toFixed(2)}</div>
                </div>
                <div class="card">
                    <h3>üëç Review Positif</h3>
                    <div class="number">${totalPositive}</div>
                    <div class="label">${((totalPositive/totalReviews)*100).toFixed(1)}% dari total</div>
                </div>
                <div class="card">
                    <h3>üìà Satisfaction Rate</h3>
                    <div class="number">${avgSatisfaction.toFixed(1)}%</div>
                    <div class="label">Average semua gerai</div>
                </div>
            `;
        }

        function generateGeraiCard(gerai) {
            const ratingNames = ['Makanan', 'Pelayanan', 'Kenyamanan', 'Kebersihan'];
            const ratingBreakdown = ratingNames.map(name => {
                const counts = gerai.ratingBreakdown[name];
                const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
                const positiveRate = total > 0 ? ((counts[5] + counts[3]) / total) * 100 : 0;
                return `
                    <div class="rating-item">
                        <span style="width: 90px; font-size: 0.85rem; font-weight: 500;">${name}</span>
                        <div class="rating-bar">
                            <div class="rating-fill" style="width: ${positiveRate}%"></div>
                        </div>
                        <span style="width: 45px; text-align: right; font-size: 0.85rem; font-weight: bold;">${positiveRate.toFixed(0)}%</span>
                    </div>
                `;
            }).join('');

            const getScoreColor = (score) => {
                if (score >= 4) return '#28a745';
                if (score >= 3) return '#ffc107';
                return '#dc3545';
            };

            return `
                <div class="gerai-card">
                    <h2>üè™ Gerai ${gerai.name}</h2>
                    <div class="score-grid">
                        <div class="score-item">
                            <div class="score-value" style="color: ${getScoreColor(gerai.sentimentScore)}">${gerai.sentimentScore.toFixed(2)}</div>
                            <div class="score-label">Sentiment Score</div>
                        </div>
                        <div class="score-item">
                            <div class="score-value" style="color: ${getScoreColor(gerai.rateScore)}">${gerai.rateScore.toFixed(2)}</div>
                            <div class="score-label">Rate Score</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div class="stats-item"><strong>${gerai.totalReviews} Total Review</strong></div>
                        <div class="stats-item">üëç ${gerai.positiveReviews} Positif | üëé ${gerai.negativeReviews} Negatif</div>
                        <div class="stats-item">üìä Tingkat Kepuasan: <span class="highlight">${gerai.satisfactionRate.toFixed(1)}%</span></div>
                    </div>
                    <div class="rating-breakdown">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üìà Rating Breakdown</h4>
                        ${ratingBreakdown}
                    </div>
                </div>
            `;
        }

        function generateInsights(processedData) {
            const sortedBySentiment = [...processedData].sort((a, b) => parseFloat(b.sentimentScore) - parseFloat(a.sentimentScore));
            const best = sortedBySentiment[0];
            const worst = sortedBySentiment[sortedBySentiment.length - 1];
            const avgScore = processedData.reduce((sum, gerai) => sum + parseFloat(gerai.sentimentScore), 0) / processedData.length;
            
            const totalReviews = processedData.reduce((sum, gerai) => sum + gerai.totalReviews, 0);
            const totalPositive = processedData.reduce((sum, gerai) => sum + gerai.positiveReviews, 0);
            
            const needsAttention = processedData.filter(g => g.sentimentScore < 3.5);
            const excellent = processedData.filter(g => g.sentimentScore >= 4.5);

            return `
                <div class="insight-item positive">
                    <strong>üèÜ Gerai Terbaik:</strong> ${best.name} dengan sentiment score ${best.sentimentScore.toFixed(2)}/5.0 dan tingkat kepuasan ${best.satisfactionRate.toFixed(1)}%
                </div>
                <div class="insight-item negative">
                    <strong>‚ö†Ô∏è Perlu Perhatian:</strong> ${worst.name} dengan sentiment score ${worst.sentimentScore.toFixed(2)}/5.0 - fokus pada perbaikan pelayanan dan kenyamanan
                </div>
                <div class="insight-item neutral">
                    <strong>üìä Performance Keseluruhan:</strong> ${avgScore.toFixed(2)}/5.0 dengan ${((totalPositive/totalReviews)*100).toFixed(1)}% review positif dari total ${totalReviews} review
                </div>
                <div class="insight-item ${excellent.length > 3 ? 'positive' : 'neutral'}">
                    <strong>‚≠ê Gerai Excellent:</strong> ${excellent.length} gerai mencapai score ‚â•4.5 (${excellent.map(g => g.name).join(', ')})
                </div>
                <div class="insight-item ${needsAttention.length > 2 ? 'negative' : 'neutral'}">
                    <strong>üéØ Action Items:</strong> ${needsAttention.length > 0 ? needsAttention.length + ' gerai perlu perbaikan: ' + needsAttention.map(g => g.name).join(', ') : 'Semua gerai perform dengan baik!'}
                </div>
            `;
        }

        // Load data dan render dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof csvData === 'undefined') {
                    document.getElementById('loading').innerHTML = '<div style="color: #ff6b6b;">‚ùå Error: Data tidak dapat dimuat. Pastikan file csv_data.js ada di folder yang sama.</div>';
                    return;
                }

                const processedData = Object.keys(csvData).map(geraiName => 
                    processGerai(geraiName, csvData[geraiName])
                );

                // Generate content
                document.getElementById('summary-cards').innerHTML = generateSummaryCards(processedData);
                document.getElementById('gerai-section').innerHTML = processedData.map(generateGeraiCard).join('');
                document.getElementById('insights').innerHTML = '<h3>üí° Insight & Rekomendasi</h3>' + generateInsights(processedData);

                // Create charts
                createSentimentChart(processedData);
                createRateChart(processedData);

                // Comments data & UI
                const allComments = buildCommentsData(csvData);
                initCommentsUI(allComments, processedData);

                // Show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            }, 1500);
        });

        function createSentimentChart(data) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Sentiment Score',
                        data: data.map(d => parseFloat(d.sentimentScore)),
                        backgroundColor: data.map(d => {
                            const score = parseFloat(d.sentimentScore);
                            if (score >= 4.5) return 'rgba(40, 167, 69, 0.8)';
                            if (score >= 3.5) return 'rgba(102, 126, 234, 0.8)';
                            if (score >= 2.5) return 'rgba(255, 193, 7, 0.8)';
                            return 'rgba(220, 53, 69, 0.8)';
                        }),
                        borderColor: data.map(d => {
                            const score = parseFloat(d.sentimentScore);
                            if (score >= 4.5) return 'rgba(40, 167, 69, 1)';
                            if (score >= 3.5) return 'rgba(102, 126, 234, 1)';
                            if (score >= 2.5) return 'rgba(255, 193, 7, 1)';
                            return 'rgba(220, 53, 69, 1)';
                        }),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const gerai = data[context.dataIndex];
                                    return [`Satisfaction: ${gerai.satisfactionRate.toFixed(1)}%`, `Total Review: ${gerai.totalReviews}`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRateChart(data) {
            const ctx = document.getElementById('rateChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => parseFloat(d.rateScore)),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const gerai = data[context.dataIndex];
                                    return `${context.label}: ${context.parsed.toFixed(2)}/5.0`;
                                },
                                afterLabel: function(context) {
                                    const gerai = data[context.dataIndex];
                                    return [`Reviews: ${gerai.totalReviews}`, `Satisfaction: ${gerai.satisfactionRate.toFixed(1)}%`];
                                }
                            }
                        }
                    }
                }
            });
        }

        // ====== Komentar & Filter ======
        function computeAvgFromRow(row) {
            const a = getScore(row[3]);
            const b = getScore(row[4]);
            const c = getScore(row[5]);
            const d = getScore(row[6]);
            return (a + b + c + d) / 4;
        }

        function inferCommentSentiment(avg, text) {
            const t = (text || '').toLowerCase();
            if (avg < 2.5 || /(tidak|kurang|kotor|berisik|panas|asin|lembek|habis|mati|serangga|lalat|gosong)/.test(t)) return 'negative';
            if (avg > 3.5 || /(mantap|enak|baik|nyaman|bersih|top|terbaik|bagus|ramah|perfect|puas)/.test(t)) return 'positive';
            return 'neutral';
        }

        function buildCommentsData(csvData) {
            const all = [];
            Object.keys(csvData).forEach(geraiName => {
                const rows = csvData[geraiName];
                const header = rows[0];
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r || r.length < 7) continue;
                    const avg = computeAvgFromRow(r);
                    const sentiment = inferCommentSentiment(avg, r[7]);
                    all.push({
                        gerai: geraiName,
                        nama: r[0] || '(anonim)',
                        kontak: r[1] || '-',
                        alamat: r[2] || '-',
                        makanan: r[3], pelayanan: r[4], kenyamanan: r[5], kebersihan: r[6],
                        komentar: r[7] || '',
                        avg: avg,
                        sentiment: sentiment
                    });
                }
            });
            return all;
        }

        function badgeClass(sentiment) {
            if (sentiment === 'positive') return 'badge positive';
            if (sentiment === 'negative') return 'badge negative';
            return 'badge neutral';
        }

        function formatScoreLabel(v) {
            if (v >= 4.5) return 'Excellent';
            if (v >= 4.0) return 'Sangat Baik';
            if (v >= 3.0) return 'Baik';
            if (v >= 2.0) return 'Perlu Perbaikan';
            return 'Buruk';
        }

        function renderComments(comments) {
            const container = document.getElementById('comments-list');
            container.innerHTML = comments.map(c => `
                <div class="comment-card">
                    <div class="comment-header">
                        <div class="comment-meta">
                            <strong>${c.nama}</strong> ¬∑ ${c.gerai}
                            <div style="font-size:.8rem; color:#9ca3af;">${c.alamat !== '-' ? c.alamat : ''}</div>
                        </div>
                        <span class="${badgeClass(c.sentiment)}">${c.sentiment.toUpperCase()}</span>
                    </div>
                    ${c.komentar ? `<div class="comment-text">${c.komentar}</div>` : `<div class="comment-text" style="color:#9ca3af;">(Tidak ada komentar)</div>`}
                    <div class="aspect-chips">
                        <span class="chip">Makanan: ${c.makanan || '-'}</span>
                        <span class="chip">Pelayanan: ${c.pelayanan || '-'}</span>
                        <span class="chip">Kenyamanan: ${c.kenyamanan || '-'}</span>
                        <span class="chip">Kebersihan: ${c.kebersihan || '-'}</span>
                        <span class="chip" style="background:#eef2ff; border-color:#c7d2fe;">Avg: ${c.avg.toFixed(2)} (${formatScoreLabel(c.avg)})</span>
                    </div>
                </div>
            `).join('');
        }

        function updateCommentsStats(list) {
            const stats = document.getElementById('comments-stats');
            const total = list.length;
            const pos = list.filter(x => x.sentiment === 'positive').length;
            const neu = list.filter(x => x.sentiment === 'neutral').length;
            const neg = list.filter(x => x.sentiment === 'negative').length;
            const avg = total ? (list.reduce((s, x) => s + x.avg, 0) / total) : 0;
            stats.innerHTML = `
                <span class="pill">Total Komentar: <strong>${total}</strong></span>
                <span class="pill">Positif: <strong>${pos}</strong></span>
                <span class="pill">Netral: <strong>${neu}</strong></span>
                <span class="pill">Negatif: <strong>${neg}</strong></span>
                <span class="pill">Rata-rata Skor: <strong>${avg.toFixed(2)}/5</strong></span>
            `;
        }

        function exportToCSV(rows, filename = 'guest-comments-export.csv') {
            const headers = ['Gerai','Nama','No HP/WA','Alamat','Rate Makanan','Rate Pelayanan','Rate Kenyamanan','Rate Kebersihan','Avg Score','Sentiment','Kritik dan Saran'];
            const csv = [headers.join(',')].concat(rows.map(r => [
                r.gerai, r.nama, r.kontak, r.alamat,
                JSON.stringify(r.makanan || ''),
                JSON.stringify(r.pelayanan || ''),
                JSON.stringify(r.kenyamanan || ''),
                JSON.stringify(r.kebersihan || ''),
                r.avg.toFixed(2), r.sentiment, JSON.stringify(r.komentar || '')
            ].join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function applyFilters(baseList) {
            const q = (document.getElementById('filterSearch').value || '').toLowerCase();
            const gerai = document.getElementById('filterGerai').value;
            const activeSeg = document.querySelector('.segment.active');
            const sentiment = activeSeg ? activeSeg.getAttribute('data-sentiment') : 'all';

            let list = baseList;
            if (gerai !== 'all') list = list.filter(x => x.gerai === gerai);
            if (sentiment !== 'all') list = list.filter(x => x.sentiment === sentiment);
            if (q) {
                list = list.filter(x =>
                    (x.nama && x.nama.toLowerCase().includes(q)) ||
                    (x.alamat && x.alamat.toLowerCase().includes(q)) ||
                    (x.komentar && x.komentar.toLowerCase().includes(q))
                );
            }
            // Sort by avg desc then sentiment
            list.sort((a,b) => b.avg - a.avg || a.sentiment.localeCompare(b.sentiment));
            return list;
        }

        // Wire-up filters after data loaded
        function initCommentsUI(allComments, processedData) {
            // Populate gerai options
            const geraiSelect = document.getElementById('filterGerai');
            processedData.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.name;
                opt.textContent = `Gerai ${g.name}`;
                geraiSelect.appendChild(opt);
            });

            let current = applyFilters(allComments);
            renderComments(current);
            updateCommentsStats(current);

            // Listeners
            document.getElementById('filterSearch').addEventListener('input', debounce(() => {
                current = applyFilters(allComments);
                renderComments(current);
                updateCommentsStats(current);
            }, 200));

            geraiSelect.addEventListener('change', () => {
                current = applyFilters(allComments);
                renderComments(current);
                updateCommentsStats(current);
            });

            document.querySelectorAll('.segment').forEach(seg => {
                seg.addEventListener('click', () => {
                    document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
                    seg.classList.add('active');
                    current = applyFilters(allComments);
                    renderComments(current);
                    updateCommentsStats(current);
                });
            });

            document.getElementById('btnExport').addEventListener('click', () => {
                const filtered = applyFilters(allComments);
                exportToCSV(filtered);
            });
        }

        function debounce(fn, wait) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
